{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "Environment": {
      "type": "string",
      "defaultValue": "prod",
      "metadata": { "description": "Please keep this setting as prod" }
    },
    "Bot ID": {
      "type": "string",
      "defaultValue": "ACU-BOT-ABS-DEV",
      "metadata": { "description": "Please enter the Bot ID" }
    },
    "Location": {
      "type": "string",
      "allowedValues": [
        "Central US",
        "North Europe",
        "West Europe",
        "Southeast Asia",
        "East Asia",
        "West US",
        "East US",
        "Japan West",
        "Japan East",
        "Japan West",
        "East US 2",
        "North Central US",
        "South Central US",
        "Brazil South",
        "Australia East",
        "Australia Southeast",
        "Central India",
        "West India",
        "South India",
        "Canada Central",
        "Canada East",
        "West Central US",
        "West US 2",
        "UK West",
        "UK South",
        "Korea South",
        "Korea Central",
        "France South",
        "France Central"
      ],
      "metadata": { "description": "Choose the preferred location for the Azure Bot Service" }
    },
    "SKU": {
      "type": "string",
      "allowedValues": [ "F0", "S1" ],
      "defaultValue": "S1",
      "metadata": { "description": "Select the plan for Azure Bot Service" }
    },
    "Kind": {
      "type": "string",
      "allowedValues": [
        "sdk",
        "bot"
      ],
      "defaultValue": "sdk",
      "metadata": { "description": "Please keep this setting as sdk" }
    },
    "Web App Name": {
      "type": "string",
      "defaultValue": "ACU-BOT-ABS-DEV",
      "metadata": { "description": "Please enter the name of BotCore runtime web app you have already created" }
    },
    "App ID": {
      "type": "string",
      "metadata": { "description": "Enter a valid GUID as App ID for Azure Bot service" }
    },
    "App Secret": {
      "type": "string",
      "metadata": { "description": "Please enter an App Secret for the Azure Bot Service" }
    },
    "Zip url": {
      "type": "string",
      "defaultValue": "",
      "metadata": { "description": "Leave as blank" }
    },
    "Proactive zip url": {
      "type": "string",
      "defaultValue": "",
      "metadata": { "description": "Leave as blank" }
    },
    "Bot Encryption key": {
      "type": "string",
      "defaultValue": "",
      "metadata": { "description": "Leave as blank" }
    },
    "BotCore Runtime Endpoint": {
      "type": "string",
      "defaultValue": "https://ACU-BOT-ABS-DEV.azurewebsites.net/api/messages",
      "metadata": { "description": "Please enter the BotCore runtime message end point URL" }
    },
    "Cognitive service Name": {
      "type": "string",
      "defaultValue": "ACU-BOT-CS-DEV",
      "metadata": { "description": "Enter the preferred name for cognitive service." }
    },
    "Cognitive Service Location for Bot Service": {
      "type": "string",
      "allowedValues": [
        "East Australia",
        "West Europe",
        "West US"
      ],
      "defaultValue": "West US",
      "metadata": { "description": "Enter the preferred name for LUIS Cognitive service" }
    },
    "Cognitive service Location": {
      "type": "string",
      "defaultValue": "West US",
      "allowedValues": [
        "West US",
        "West US 2",
        "West Europe",
        "North Europe",
        "Australia East",
        "Brazil South",
        "Southeast Asia",
        "East Asia"
      ],
      "metadata": { "description": "Please choose location for LUIS" }
    },
    "Cognitive Service Type": {
      "type": "string",
      "allowedValues": [
        "LUIS"
      ],
      "defaultValue": "LUIS",
      "metadata": { "description": "Leave as LUIS" }
    },
    "Cognitive service SKU": {
      "type": "string",
      "allowedValues": [
        "F0",
        "S0"
      ],
      "defaultValue": "S0",
      "metadata": { "description": "Please choose SKU for LUIS" }
    },
    "Resource Group Name": {
      "type": "string",
      "defaultValue": "ACU-BOT-RG-DEV",
      "metadata": { "description": "Please re- enter the name of resource group here." }
    },
    "Function App": {
      "type": "string",
      "defaultValue": "ACU-BOT-AFA-DEV",
      "metadata": { "description": "Please enter the name of the funtion app for BotCore actions" }
    },
    "Function app Location": {
      "type": "string",
      "defaultValue": "West US",
      "allowedValues": [
        "Australia East",
        "Australia Southeast",
        "Brazil South",
        "Canada Central",
        "Canada East",
        "Central India",
        "Central US",
        "East Asia",
        "East US",
        "East US 2",
        "France Central",
        "Japan East",
        "Japan West",
        "North Central US",
        "North Europe",
        "South Central US",
        "South India",
        "Southeast Asia",
        "UK South",
        "UK West",
        "West Central US",
        "West Europe",
        "West India",
        "West US",
        "West US 2"
      ],
      "metadata": { "description": "Please choose the prefered location of the function app." }
    },
    "Storage Account Name": {
      "type": "string",
      "defaultValue": "acubotstoragedev",
      "metadata": { "description": "Please enter the name of the storage account you have already created" }
    },  
    "Subscription ID": {
      "type": "string",
      "metadata": { "description": "Please enter the subscription id of the resource group" }
    }
  },
  "variables": {
    "myWorkerSize": 0,
    "proactiveFunctionName": "[concat(parameters('Web App Name'), '-function')]",
    "insightsName": "[concat(parameters('Bot ID'), substring(uniqueString(resourceGroup().id), 0, 6))]",
    "config": {
      "scratch": {
        "stateEndpoint": "https://intercom-api-scratch.azurewebsites.net",
        "azureWebJobsBotFrameworkDirectLineEndpoint": "https://directline.scratch.botframework.com/",
        "openIdMetadata": "https://intercom-api-ppe.azurewebsites.net/v1/.well-known/openidconfiguration"
      },
      "ppe": {
        "stateEndpoint": "https://intercom-api-ppe.azurewebsites.net",
        "azureWebJobsBotFrameworkDirectLineEndpoint": "https://directline.ppe.botframework.com/",
        "openIdMetadata": "https://intercom-api-ppe.azurewebsites.net/v1/.well-known/openidconfiguration"
      },
      "prod": {
        "stateEndpoint": "",
        "azureWebJobsBotFrameworkDirectLineEndpoint": "https://directline.botframework.com/",
        "openIdMetadata": ""
      },
      "usgovppe": {
        "stateEndpoint": "",
        "azureWebJobsBotFrameworkDirectLineEndpoint": "https://directline.ppe.botframework.azure.us/",
        "openIdMetadata": "https://api.ppe.botframework.azure.us/v1/.well-known/openidconfigurationn"
      },
      "usgovprd": {
        "stateEndpoint": "",
        "azureWebJobsBotFrameworkDirectLineEndpoint": "https://directline.botframework.azure.us/",
        "openIdMetadata": "https://api.botframework.azure.us/v1/.well-known/openidconfiguration"
      }
    },
    "botAppKinds": {
      "function": "functionapp",
      "sdk": "app",
      "designer": "app",
      "bot": ""
    },
    "botAppKind": "[variables('botAppKinds')[parameters('Kind')]]",
    "currentConfig": "[variables('config')[toLower(parameters('Environment'))]]",
    "siteHost": "[concat(parameters('Web App Name'), '.azurewebsites.net')]",
    "botEndpointConfig": {
      "bot": "[parameters('BotCore Runtime Endpoint')]",
      "sdk": "[concat('https://', variables('siteHost'), '/api/messages')]",
      "designer": "[concat('https://', variables('siteHost'), '/api/messages')]",
      "function": "[concat('https://', variables('siteHost'), '/api/messages?code=', 'NYI')]"
    },
    "botEndpoint": "[variables('botEndpointConfig')[parameters('kind')]]",
    "luisApiName": "",
    "luisApiResId": "[resourceId('Microsoft.CognitiveServices/accounts/', variables('luisApiName'))]"
  },
  "resources": [
    {
      "name": "[if(equals('', variables('luisApiName')), 'nosuch', variables('luisApiName'))]",
      "apiVersion": "2017-04-18",
      "condition": "[not(equals(variables('luisApiName'), ''))]",
      "type": "Microsoft.CognitiveServices/accounts",
      "location": "[parameters('Cognitive Service Location for Bot Service')]",
      "sku": {
        "name": "F0"
      },
      "kind": "LUIS",
      "properties": {}
    },
    {
      "name": "[parameters('Web App Name')]",
      "type": "Microsoft.Web/sites",
      "apiVersion": "2015-08-01",
      "condition": "[not(equals(parameters('Zip url'), ''))]",
      "location": "[parameters('Location')]",
      "kind": "[variables('botAppKind')]",
      "properties": {
        "name": "[parameters('Web App Name')]",
        "siteConfig": {
          "appSettings": [
            {
              "name": "botFilePath",
              "value": "[concat('./', parameters('Bot ID'), '.bot')]"
            },
            {
              "name": "botFileSecret",
              "value": "[parameters('Bot Encryption key')]"
            }
          ],
          "cors": {
            "allowedOrigins": [
              "https://botservice.hosting.portal.azure.net",
              "https://hosting.onecloud.azure-test.net/"
            ]
          }
        }
      },
      "resources": [
        {
          "name": "MSDeploy",
          "type": "Extensions",
          "apiVersion": "2015-02-01",
          "condition": "[not(equals(parameters('Zip url'), ''))]",
          "dependsOn": [
            "[concat('Microsoft.Web/Sites/', parameters('Web App Name'))]"
          ],
          "properties": {
            "packageUri": "[parameters('Zip url')]",
            "dbType": "None",
            "connectionString": "",
            "setParameters": {
              "IIS Web Application Name": "[parameters('Web App Name')]"
            }
          }
        }
      ]
    },
    {
      "apiVersion": "2016-03-01",
      "type": "Microsoft.Web/sites",
      "condition": "[not(equals(parameters('Proactive zip url'), ''))]",
      "name": "[variables('proactiveFunctionName')]",
      "location": "[parameters('location')]",
      "kind": "functionapp",
      "properties": {
        "siteConfig": {
          "appSettings": [
            {
              "name": "WEBSITE_CONTENTSHARE",
              "value": "[toLower(variables('proactiveFunctionName'))]"
            },
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~1"
            },
            {
              "name": "AzureWebJobsBotFrameworkDirectLineEndpoint",
              "value": "[variables('currentConfig').azureWebJobsBotFrameworkDirectLineEndpoint]"
            }
          ]
        }
      },
      "resources": [
        {
          "name": "MSDeploy",
          "type": "Extensions",
          "apiVersion": "2015-02-01",
          "condition": "[not(equals(parameters('Proactive zip url'), ''))]",
          "dependsOn": [
            "[concat('Microsoft.Web/Sites/', variables('proactiveFunctionName'))]"
          ],
          "properties": {
            "packageUri": "[parameters('Proactive zip url')]"
          }
        }
      ]
    },
    {
      "apiVersion": "2017-12-01",
      "type": "Microsoft.BotService/botServices",
      "name": "[parameters('Bot ID')]",
      "location": "global",
      "kind": "[parameters('Kind')]",
      "sku": {
        "name": "[parameters('SKU')]"
      },
      "properties": {
        "name": "[parameters('Bot ID')]",
        "displayName": "[parameters('Bot ID')]",
        "endpoint": "[variables('botEndpoint')]",
        "msaAppId": "[parameters('App ID')]",
        "publishingCredentials": "[list(concat(resourceId('Microsoft.Web/Sites', parameters('Web App Name')), '/config/publishingcredentials'), '2018-02-01')]",
        "parameters": "[union(deployment().properties.parameters, json(concat('{\"tenant\":{\"value\":\"', subscription().tenantId, '\"}}')), json(concat('{\"stateStorage\":{\"value\":\"DefaultEndpointsProtocol=https;AccountName=',';\"}}')))]",
        "allSettings": {
          "WEBSITE_NODE_DEFAULT_VERSION": "8.9.4",
          "BotEnv": "[parameters('Environment')]",
          "BotId": "[parameters('Bot ID')]",
          "MicrosoftAppId": "[parameters('App ID')]",
          "MicrosoftAppPassword": "[parameters('App Secret')]",
          "BotStateEndpoint": "[variables('currentConfig').stateEndpoint]",
          "BotOpenIdMetadata": "[variables('currentConfig').openIdMetadata]",
          "UseTableStorageForConversationState": "true",
          "botFilePath": "[concat('./', parameters('Bot ID'), '.bot')]",
          "botFileSecret": "[parameters('Bot Encryption key')]",
          "LuisAPIKey": "374ee135421e45db8420cbec05e02bd9",
          "LuisAppId": "dab3bae8-e0f4-4ce2-ae5e-48acc5962edd",
          "LuisAPIHostName": "westus.api.cognitive.microsoft.com"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites/', parameters('Web App Name'))]",
        "MSDeploy"
      ]
    },
    {
      "apiVersion": "2017-04-18",
      "name": "[parameters('Cognitive service Name')]",
      "location": "[parameters('Cognitive Service Location for Bot Service')]",
      "type": "Microsoft.CognitiveServices/accounts",
      "kind": "[parameters('Cognitive Service Type')]",
      "sku": {
        "name": "[parameters('Cognitive service SKU')]"
      },
      "properties": {}
    },
    {
      "apiVersion": "2016-03-01",
      "name": "[parameters('Function App')]",
      "type": "Microsoft.Web/sites",
      "properties": {
        "name": "[parameters('Function App')]",
        "siteConfig": {
          "appSettings": [
            {
              "name": "FUNCTIONS_WORKER_RUNTIME",
              "value": "dotnet"
            },
            {
              "name": "AzureWebJobsStorage",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('Storage Account Name'),';AccountKey=',listKeys(resourceId(parameters('Subscription id'),parameters('Resource Group Name'),'Microsoft.Storage/storageAccounts', parameters('Storage Account Name')), '2015-05-01-preview').key1)]"
            },
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~2"
            },
            {
              "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('Storage Account Name'),';AccountKey=',listKeys(resourceId(parameters('Subscription id'),parameters('Resource Group Name'),'Microsoft.Storage/storageAccounts', parameters('Storage Account Name')), '2015-05-01-preview').key1)]"
            },
            {
              "name": "WEBSITE_CONTENTSHARE",
              "value": "[concat(toLower(parameters('Storage Account Name')), '8875')]"
            },
            {
              "name": "WEBSITE_NODE_DEFAULT_VERSION",
              "value": "8.11.1"
            }
          ]
        },
        "clientAffinityEnabled": false,
        "reserved": false
      },
      "location": "[parameters('Function app Location')]",
      "kind": "functionapp"
    },
    {
      "apiVersion": "2018-02-01",
      "name": "pid-a9d60af4-e8f2-4928-b6d4-64445afc7bd3",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": []
        }
      }
    }
  ]
}
